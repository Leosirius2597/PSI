cmake_minimum_required(VERSION 3.15)
project(PSI C)

# ==============================
# ğŸ”§ é¡¹ç›®é…ç½®
# ==============================

# è‡ªåŠ¨å¯¼å‡º compile_commands.json ä¾› clangd ä½¿ç”¨
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# C æ ‡å‡†
set(CMAKE_C_STANDARD 11)
set(CMAKE_C_STANDARD_REQUIRED ON)

# è¾“å‡ºç›®å½•
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR})

# ==============================
# ğŸ“¦ æŸ¥æ‰¾ä¾èµ–åº“
# ==============================

# macOS Homebrew è·¯å¾„é…ç½®
if(APPLE)
    set(HOMEBREW_PREFIX "/opt/homebrew")
    
    # OpenMP
    set(OpenMP_C_FLAGS "-Xpreprocessor -fopenmp")
    set(OpenMP_C_LIB_NAMES "omp")
    set(OpenMP_omp_LIBRARY "${HOMEBREW_PREFIX}/opt/libomp/lib/libomp.dylib")
    include_directories("${HOMEBREW_PREFIX}/opt/libomp/include")
    
    # GMP
    include_directories("${HOMEBREW_PREFIX}/opt/gmp/include")
    link_directories("${HOMEBREW_PREFIX}/opt/gmp/lib")
    
    # OpenSSL
    include_directories("${HOMEBREW_PREFIX}/opt/openssl/include")
    link_directories("${HOMEBREW_PREFIX}/opt/openssl/lib")
endif()

find_package(OpenMP REQUIRED)

# ==============================
# ğŸ“ æºæ–‡ä»¶åˆ—è¡¨
# ==============================

set(SOURCES
    main.c
    PSI.c
    PSI_Cloud.c
    client.c
    Verify.c
    Beaver_Cloud.c
    beaver.c
    bucket.c
    crt_gmp.c
    crypt.c
    dataset.c
    fft_poly.c
    hash.c
    modsystem.c
)

set(HEADERS
    PSI.h
    PSI_Cloud.h
    client.h
    Verify.h
    Beaver_Cloud.h
    beaver.h
    bucket.h
    crt_gmp.h
    crypt.h
    dataset.h
    fft_poly.h
    hash.h
    modsystem.h
)

# ==============================
# ğŸ¯ å¯æ‰§è¡Œæ–‡ä»¶ç›®æ ‡
# ==============================

add_executable(psi_program ${SOURCES} ${HEADERS})

# ==============================
# âš™ï¸ ç¼–è¯‘é€‰é¡¹
# ==============================

# é€šç”¨ç¼–è¯‘é€‰é¡¹
target_compile_options(psi_program PRIVATE
    -Wall
    -O1
    -g
)

# AddressSanitizer
target_compile_options(psi_program PRIVATE
    -fsanitize=address
    -fno-omit-frame-pointer
    -fno-optimize-sibling-calls
)

# OpenMP
target_compile_options(psi_program PRIVATE
    ${OpenMP_C_FLAGS}
)

# ==============================
# ğŸ”— é“¾æ¥åº“
# ==============================

target_link_libraries(psi_program PRIVATE
    gmp
    crypto
    ssl
    m
    pthread
    ${OpenMP_omp_LIBRARY}
)

# AddressSanitizer é“¾æ¥é€‰é¡¹
target_link_options(psi_program PRIVATE
    -fsanitize=address
)

# ==============================
# ğŸ è°ƒè¯•ç›®æ ‡
# ==============================

add_executable(psi_program_debug ${SOURCES} ${HEADERS})

target_compile_options(psi_program_debug PRIVATE
    -Wall
    -O0
    -g
    -fsanitize=address
    -fno-omit-frame-pointer
    -fno-optimize-sibling-calls
    ${OpenMP_C_FLAGS}
)

target_link_libraries(psi_program_debug PRIVATE
    gmp
    crypto
    ssl
    m
    pthread
    ${OpenMP_omp_LIBRARY}
)

target_link_options(psi_program_debug PRIVATE
    -fsanitize=address
)

# ==============================
# ğŸ“„ å®‰è£…é…ç½®
# ==============================

install(TARGETS psi_program
    RUNTIME DESTINATION bin
)

# ==============================
# ğŸ’¡ æç¤ºä¿¡æ¯
# ==============================

message(STATUS "ğŸ”§ PSI é¡¹ç›®é…ç½®å®Œæˆ")
message(STATUS "ğŸ“¦ è¾“å‡ºç›®å½•: ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}")
message(STATUS "ğŸ“ compile_commands.json å°†ç”Ÿæˆåœ¨æ„å»ºç›®å½•")
message(STATUS "")
message(STATUS "ğŸ’¡ æ„å»ºæ­¥éª¤:")
message(STATUS "   mkdir -p build && cd build")
message(STATUS "   cmake ..")
message(STATUS "   make -j$(nproc)")
message(STATUS "")
message(STATUS "ğŸ’¡ è¿è¡Œå‰è¯·è®¾ç½®:")
message(STATUS "   export ASAN_OPTIONS=fast_unwind_on_malloc=0:malloc_context_size=50")


